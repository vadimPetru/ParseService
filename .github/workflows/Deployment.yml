name: Deploy .NET Background Service

on:
  push:
    branches: [ "master" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
      uses: actions/checkout@v4

    - name: âš™ï¸ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° .NET 8.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: ðŸ“¦ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      run: dotnet restore

    - name: ðŸ—ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
      run: dotnet build --no-restore --configuration Release

    - name: âœ… Ð—Ð°Ð¿ÑƒÑÐº unit-Ñ‚ÐµÑÑ‚Ð¾Ð²
      run: dotnet test --no-build --verbosity normal --configuration Release

    - name: ðŸš€ ÐŸÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
      run: dotnet publish -c Release -o publish

    - name: ðŸ“¤ ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
      run: |
        echo "ðŸ“‚ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ð³Ð¾ publish/"
        ls -la publish || echo "âŒ ÐŸÐ°Ð¿ÐºÐ° publish Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°!"
        echo "ðŸ“¤ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð°Ð¿ÐºÐ¸ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ..."
        sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p /var/www/myapp/"
        echo "ðŸ“¤ ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ñ‡ÐµÑ€ÐµÐ· SCP..."
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no -r publish/* ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/myapp/
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no -r ./ParseService/Migrations ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/myapp/Migrations
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no ./ParseService/ParseService.csproj ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/myapp/ParseService.csproj

    - name: ðŸ”„ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        script: |
          echo "ðŸ› ï¸ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ°..."
          sudo systemctl stop myservice || true
    
          echo "ðŸ“œ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°..."
          sudo chmod -R 755 /var/www/myapp/
    
          echo "ðŸ” Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° secret.json..."
          sudo bash -c "cat > /var/www/myapp/secret.json <<EOF
          {
             \"MainOptions\": {
              \"TELEGRAM_TOKEN\": \"${{ secrets.TELEGRAM_TOKEN }}\",
              \"CHAT_ID\": \"${{ secrets.CHAT_ID }}\",
              \"MAIN_URL\": \"${{ secrets.MAIN_URL }}\"
              }
            
          }
          EOF"

          echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°..."
          sudo systemctl start myservice
        
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚ÑŒ ÑÐµÑ€Ð²Ð¸ÑÐ°
          echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ñ‚Ð° ÑÐµÑ€Ð²Ð¸ÑÐ°..."
          sleep 10  # Ð”Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ ÑÐµÑ€Ð²Ð¸ÑÑƒ Ð½Ð° Ð·Ð°Ð¿ÑƒÑÐº
          echo "ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° ÑÐµÑ€Ð²Ð¸ÑÐ°..."
          sudo systemctl is-active --quiet myservice && echo "âœ… Ð¡ÐµÑ€Ð²Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!" || echo "âŒ Ð¡ÐµÑ€Ð²Ð¸Ñ Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!"
          
    - name: Ensure database file exists
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        script: |
          echo "ðŸ“‚ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ Ð¿Ð°Ð¿ÐºÐ° /var/www/myapp/..."
          if [ ! -d "/var/www/myapp/" ]; then
            echo "ðŸ“ ÐŸÐ°Ð¿ÐºÐ° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°. Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼..."
            mkdir -p /var/www/myapp/
          else
            echo "âœ… ÐŸÐ°Ð¿ÐºÐ° ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚. ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ."
          fi
          
          echo "ðŸ“‚ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ Ñ„Ð°Ð¹Ð» Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
          if [ ! -f "/var/www/myapp/app.db" ]; then
            echo "ðŸ“œ Ð¤Ð°Ð¹Ð» Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼..."
            touch /var/www/myapp/app.db
          else
            echo "âœ… Ð¤Ð°Ð¹Ð» Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚."
          fi
    
          echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° /var/www/myapp/app.db..."
          chmod 777 /var/www/myapp/app.db
    
          echo "ðŸ“‚ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð² /var/www/myapp/:"
          ls -la /var/www/myapp/
          
    - name: Run migrations
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        script: |
          echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° EF Core CLI..."
          dotnet tool install --global dotnet-ef || echo "dotnet-ef ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
          
          echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ PATH..."
          export PATH="$HOME/.dotnet/tools:$PATH"

          echo "ðŸš€ Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
          cd /var/www/myapp
          dotnet ef database update --project /var/www/myapp/ParseService.csproj --environment Production

    - name: Restart service
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        script: |
          echo "ðŸš€ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°..."
          sudo systemctl restart myservice

    - name: âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ
      run: echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
