name: Deploy .NET Background Service

on:
  push:
    branches: [ "master" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Клонирование репозитория
      uses: actions/checkout@v4

    - name: ⚙️ Установка .NET 8.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: 📦 Восстановление зависимостей
      run: dotnet restore

    - name: 🏗️ Сборка проекта
      run: dotnet build --no-restore --configuration Release

    - name: ✅ Запуск unit-тестов
      run: dotnet test --no-build --verbosity normal --configuration Release

    - name: 🚀 Публикация проекта
      run: dotnet publish -c Release -o publish

    - name: 📤 Копирование файлов на сервер
      run: |
        echo "📂 Проверка содержимого publish/"
        ls -la publish || echo "❌ Папка publish не найдена!"
        echo "📤 Создание папки на сервере..."
        sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p /var/www/myapp/"
        echo "📤 Копирование файлов через SCP..."
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no -r publish/* ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/myapp/
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no -r ./ParseService/Migrations ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/myapp/Migrations
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no ./ParseService/ParseService.csproj ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/myapp/ParseService.csproj

    - name: 🔄 Деплой на сервер
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        script: |
          echo "🛠️ Остановка сервиса..."
          sudo systemctl stop myservice || true
    
          echo "📜 Настройка прав доступа..."
          sudo chmod -R 755 /var/www/myapp/
    
          echo "🔐 Создание файла secret.json..."
          sudo bash -c "cat > /var/www/myapp/secret.json <<EOF
          {
             \"MainOptions\": {
              \"TELEGRAM_TOKEN\": \"${{ secrets.TELEGRAM_TOKEN }}\",
              \"CHAT_ID\": \"${{ secrets.CHAT_ID }}\",
              \"MAIN_URL\": \"${{ secrets.MAIN_URL }}\"
              }
            
          }
          EOF"

          echo "🚀 Запуск сервиса..."
          sudo systemctl start myservice
        
          # Проверка на работоспособность сервиса
          echo "⏳ Ожидание старта сервиса..."
          sleep 10  # Даем время сервису на запуск
          echo "📊 Проверка статуса сервиса..."
          sudo systemctl is-active --quiet myservice && echo "✅ Сервис работает!" || echo "❌ Сервис не работает!"
          
    - name: Ensure database file exists
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        script: |
          echo "📂 Проверяем, существует ли папка /var/www/myapp/..."
          if [ ! -d "/var/www/myapp/" ]; then
            echo "📁 Папка не найдена. Создаём..."
            mkdir -p /var/www/myapp/
          else
            echo "✅ Папка уже существует. Пропускаем создание."
          fi
          
          echo "📂 Проверяем, существует ли файл базы данных..."
          if [ ! -f "/var/www/myapp/app.db" ]; then
            echo "📜 Файл базы данных не найден. Создаём..."
            touch /var/www/myapp/app.db
          else
            echo "✅ Файл базы данных уже существует."
          fi
    
          echo "🔧 Устанавливаем права на /var/www/myapp/app.db..."
          chmod 777 /var/www/myapp/app.db
    
          echo "📂 Проверяем файлы в /var/www/myapp/:"
          ls -la /var/www/myapp/
          
    - name: Run migrations
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        script: |
          echo "📦 Установка EF Core CLI..."
          dotnet tool install --global dotnet-ef || echo "dotnet-ef уже установлен"
          
          echo "🔄 Обновление переменной PATH..."
          export PATH="$HOME/.dotnet/tools:$PATH"

          echo "🚀 Выполнение миграций базы данных..."
          cd /var/www/myapp
          dotnet ef database update --project /var/www/myapp/ParseService.csproj --environment Production

    - name: Restart service
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        script: |
          echo "🚀 Перезапуск сервиса..."
          sudo systemctl restart myservice

    - name: ✅ Успешное завершение
      run: echo "✅ Деплой завершён успешно!"
