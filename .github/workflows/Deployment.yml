name: Deploy .NET Background Service

on:
  push:
    branches: [ "master" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ .NET 8.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: üì¶ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: dotnet restore

    - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
      run: dotnet build --no-restore --configuration Release

    - name: ‚úÖ –ó–∞–ø—É—Å–∫ unit-—Ç–µ—Å—Ç–æ–≤
      run: dotnet test --no-build --verbosity normal --configuration Release

    - name: üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
      run: dotnet publish -c Release -o publish

    - name: üîÑ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        script: |
          echo "üõ†Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–∞..."
          sudo systemctl stop myservice || true

          echo "üìÇ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤..."
          sudo rm -rf /var/www/myapp/*

          sudo apt-get update && sudo apt-get install -y sshpass
          echo "üì§ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤..."
          sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no -r publish/* ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/myapp/

          echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
          echo "TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }}" | sudo tee /etc/environment
          echo "CHAT_ID=${{ secrets.CHAT_ID }}" | sudo tee -a /etc/environment
          echo "MAIN_URL=${{ secrets.MAIN_URL }}" | sudo tee -a /etc/environment
          source /etc/environment

          echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞..."
          sudo systemctl restart myservice

    - name: ‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
      run: echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!"
